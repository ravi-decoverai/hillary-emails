<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HRC Email Archive — Communication Stats</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, 'Segoe UI', Roboto, sans-serif; background: #f6f8fc; color: #202124; line-height: 1.6; }

  .header {
    background: #fff; height: 64px; display: flex; align-items: center;
    padding: 0 24px; border-bottom: 1px solid #e0e0e0; position: fixed;
    top: 0; left: 0; right: 0; z-index: 100;
  }
  .header .logo { display: flex; align-items: center; gap: 10px; font-size: 20px; color: #5f6368; }
  .header .logo strong { color: #1a73e8; }
  .header-nav { margin-left: auto; display: flex; gap: 20px; font-size: 14px; }
  .header-nav a { color: #0645ad; text-decoration: none; }
  .header-nav a:hover { text-decoration: underline; }
  .header-nav a.active { font-weight: 700; color: #202124; }

  .container { max-width: 1200px; margin: 80px auto 40px; padding: 0 24px; }

  h1 { font-size: 28px; font-weight: 400; margin-bottom: 8px; }
  .subtitle { color: #5f6368; font-size: 15px; margin-bottom: 24px; }

  /* Summary cards */
  .summary-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
  .summary-card {
    background: #fff; border-radius: 12px; padding: 20px; border: 1px solid #e0e0e0;
    text-align: center;
  }
  .summary-card .num { font-size: 32px; font-weight: 700; color: #1a73e8; }
  .summary-card .label { font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

  /* Sections */
  .section { background: #fff; border-radius: 12px; border: 1px solid #e0e0e0; padding: 24px; margin-bottom: 24px; }
  .section h2 { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #202124; }
  .section h3 { font-size: 14px; font-weight: 600; margin: 16px 0 8px; color: #5f6368; }

  /* Bar charts */
  .bar-chart { margin-bottom: 8px; }
  .bar-row { display: flex; align-items: center; margin-bottom: 6px; gap: 8px; }
  .bar-label { width: 200px; font-size: 13px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .bar-track { flex: 1; background: #f1f3f4; border-radius: 4px; height: 24px; position: relative; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding-left: 8px; }
  .bar-value { font-size: 11px; font-weight: 600; color: #fff; white-space: nowrap; }
  .bar-count { width: 50px; text-align: right; font-size: 13px; font-weight: 600; color: #5f6368; flex-shrink: 0; }

  /* Heatmap / Matrix */
  .matrix-container { overflow-x: auto; }
  .matrix-table { border-collapse: collapse; font-size: 11px; }
  .matrix-table th { padding: 4px 6px; font-weight: 600; color: #5f6368; writing-mode: vertical-rl; text-orientation: mixed; max-width: 30px; }
  .matrix-table td { padding: 0; width: 32px; height: 32px; text-align: center; font-weight: 600; cursor: default; position: relative; }
  .matrix-cell {
    width: 28px; height: 28px; border-radius: 4px; display: flex;
    align-items: center; justify-content: center; margin: 2px auto;
    font-size: 10px; color: #fff; transition: transform 0.1s;
  }
  .matrix-cell:hover { transform: scale(1.3); z-index: 2; }
  .matrix-table .row-label { text-align: right; padding-right: 8px; font-weight: 600; color: #5f6368; white-space: nowrap; writing-mode: horizontal-tb; width: auto; }

  /* Timeline */
  .timeline-chart { display: flex; align-items: flex-end; gap: 2px; height: 160px; padding: 0 0 24px; position: relative; }
  .timeline-bar {
    flex: 1; background: #4285f4; border-radius: 2px 2px 0 0; min-width: 4px;
    transition: height 0.4s ease; position: relative; cursor: pointer;
  }
  .timeline-bar:hover { background: #1967d2; }
  .timeline-bar:hover::after {
    content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%;
    transform: translateX(-50%); background: #202124; color: #fff;
    padding: 4px 8px; border-radius: 4px; font-size: 11px; white-space: nowrap; z-index: 10;
  }
  .timeline-labels { display: flex; gap: 2px; font-size: 10px; color: #5f6368; }
  .timeline-labels span { flex: 1; text-align: center; min-width: 4px; }

  /* Pair analysis */
  .pair-table { width: 100%; border-collapse: collapse; }
  .pair-table th { text-align: left; padding: 8px 12px; border-bottom: 2px solid #e0e0e0; font-size: 12px; color: #5f6368; text-transform: uppercase; }
  .pair-table td { padding: 8px 12px; border-bottom: 1px solid #f1f3f4; font-size: 13px; }
  .pair-table tr:hover { background: #f8f9fa; }
  .pair-rank { font-weight: 700; color: #1a73e8; width: 40px; }
  .pair-names { font-weight: 600; }
  .pair-bar-cell { width: 40%; }
  .pair-bar { height: 20px; border-radius: 10px; background: linear-gradient(90deg, #4285f4, #34a853); }

  /* Category breakdown */
  .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .cat-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; background: #fafafa; }
  .cat-card-title { font-weight: 700; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
  .cat-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
  .cat-card .stat-row { display: flex; justify-content: space-between; font-size: 13px; padding: 3px 0; border-bottom: 1px solid #f1f3f4; }
  .cat-card .stat-row:last-child { border-bottom: none; }

  .tooltip { position: relative; }

  @media (max-width: 768px) {
    .bar-label { width: 120px; }
    .summary-row { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <svg width="32" height="32" viewBox="0 0 40 40" fill="none">
      <rect width="40" height="40" rx="8" fill="#1a73e8"/>
      <text x="20" y="28" text-anchor="middle" font-size="22" font-weight="700" fill="#fff">S</text>
    </svg>
    <span><strong>HRC</strong> Stats</span>
  </div>
  <div class="header-nav">
    <a href="index.html">Email Viewer</a>
    <a href="wiki.html">People Wiki</a>
    <a href="stats.html" class="active">Stats</a>
  </div>
</div>

<div class="container">
  <h1>Communication Analytics</h1>
  <p class="subtitle">Who talked to whom, how often, and about what — derived from the Hillary Clinton email archive.</p>

  <div class="summary-row" id="summaryRow"></div>

  <div class="section">
    <h2>Email Volume Timeline</h2>
    <div class="timeline-chart" id="timeline"></div>
    <div class="timeline-labels" id="timelineLabels"></div>
  </div>

  <div class="section">
    <h2>Top Senders</h2>
    <div class="bar-chart" id="topSenders"></div>
  </div>

  <div class="section">
    <h2>Top Recipients</h2>
    <div class="bar-chart" id="topRecipients"></div>
  </div>

  <div class="section">
    <h2>Most Active Conversation Pairs</h2>
    <p style="font-size:13px;color:#5f6368;margin-bottom:16px;">People who exchanged the most emails with each other (both directions combined).</p>
    <table class="pair-table" id="pairTable">
      <thead><tr><th>#</th><th>Conversation Pair</th><th>Emails</th><th>Frequency</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Communication Matrix (Top 12 People)</h2>
    <p style="font-size:13px;color:#5f6368;margin-bottom:16px;">Heatmap showing email volume between the top communicators. Darker = more emails.</p>
    <div class="matrix-container" id="matrixContainer"></div>
  </div>

  <div class="section">
    <h2>Legal Category Breakdown</h2>
    <p style="font-size:13px;color:#5f6368;margin-bottom:16px;">Emails flagged by legal category with top correspondents in each.</p>
    <div class="cat-grid" id="catGrid"></div>
  </div>
</div>

<script>
let emails = [];

const KNOWN_NAMES = {
  'h': 'Hillary Clinton', 'hrod17': 'Hillary Clinton',
  'abedinh': 'Huma Abedin', 'abedin, huma': 'Huma Abedin', 'huma abedin': 'Huma Abedin',
  'millscd': 'Cheryl Mills', 'mills, cheryl d': 'Cheryl Mills', 'mills, cheryl 0': 'Cheryl Mills', 'cheryl.mills': 'Cheryl Mills',
  'sullivanjj': 'Jake Sullivan', 'sullivan, jacob j': 'Jake Sullivan', 'sullivan, jacobi': 'Jake Sullivan', 'jake.sullivan': 'Jake Sullivan',
  'jilotylc': 'Lauren Jiloty',
  'valmorolj': 'Lona Valmoro', 'valmorou': 'Lona Valmoro',
  'hanleymr': 'Monica Hanley', 'hanley, monica r': 'Monica Hanley',
  'preines': 'Philippe Reines', 'reines, philippe i': 'Philippe Reines', 'reinesp': 'Philippe Reines',
  'blumenthal, sidney': 'Sidney Blumenthal', 'sidney blumenthal': 'Sidney Blumenthal', 'sbwhoeop': 'Sidney Blumenthal',
  'russorv': 'Robert Russo',
  'schwerin, daniel b': 'Daniel Schwerin',
  'muscatinel': 'Lissa Muscatine',
  'kennedy, patrick f': 'Patrick Kennedy',
  'slaughter, anne-marie': 'Anne-Marie Slaughter',
  'steinbergjb': 'James Steinberg',
  'toiv, nora f': 'Nora Toiv',
  'verveerms': 'Melanne Verveer', 'pverveer': 'Melanne Verveer',
  'marshall, capricia p': 'Capricia Marshall',
  'coleman, claire l': 'Claire Coleman',
  'sherman, wendy r': 'Wendy Sherman',
  'crowleypj': 'Philip Crowley',
  'oscar flores': 'Oscar Flores',
  'jake sullivan': 'Jake Sullivan',
};

const CATEGORIES = {
  classified: { name: '18 USC §793 — Classified', color: '#c5221f',
    keywords: ['classified','confidential','secret','top secret','sensitive','noforn','redact','b1','b6','b5','1.4(b)','1.4(d)','declassif','intelligence','nsa','cia','dni','sigint','humint','comint','sci','sap','national defense','portion marked','derivatively classified'] },
  'personal-server': { name: '18 USC §1924 — Unauth Removal', color: '#8430ce',
    keywords: ['private server','personal email','hdr22','clintonemail','home server','personal server','blackberry','ipad','secure fax','secure phone','non-paper','off the record','remove heading','remove classification','send nonsecure','non-secure','unclass','unauthorized','private account','unsecured'] },
  deleted: { name: '18 USC §2071 — Record Destruction', color: '#d93025',
    keywords: ['delete','deleted','destroy','destroyed','wipe','wiped','bleachbit','print and delete','burn','shred','remove from','get rid of','scrub','dispose','purge','erase','conceal'] },
  'false-statements': { name: '18 USC §1001 — False Statements', color: '#e37400',
    keywords: ['no classified','did not send','did not receive','never','deny','not aware','nothing classified','no markings','single device','one device','convenience','permitted','turned over all','provided all','every email'] },
  obstruction: { name: '18 USC §1505 — Obstruction', color: '#b71c1c',
    keywords: ['subpoena','congressional','committee','investigation','testimony','hearing','oversight','foia','inspector general','fbi','doj','grand jury','inquiry','compliance','produce documents','litigation hold','preserve','spoliation'] },
  benghazi: { name: 'Benghazi Investigation', color: '#ff6f00',
    keywords: ['benghazi','libya','libyan','qaddafi','gaddafi','tripoli','stevens','consulate attack','annex','militia','special mission','diplomatic security','arb','talking points','susan rice','video','protest'] },
  influence: { name: '22 USC §611 — FARA', color: '#137333',
    keywords: ['saudi','qatar','uae','bahrain','donation','donor','foreign government','foreign agent','foreign contribution','lobbying','lobby','doug band','huma','blumenthal','favors','favor','access','prince','king','sheikh','intermediary'] },
  foundation: { name: '18 USC §201 — Pay-to-Play', color: '#00897b',
    keywords: ['clinton foundation','cgep','clinton global','cgi','foundation','laureate','teneo','speeches','speaking fee','donors','fundrais','charitable','quid pro quo','meeting request','appointment','conflict of interest','ethics'] },
  spillage: { name: 'Intel Spillage', color: '#4a148c',
    keywords: ['sid','sidney','sources','methods','operative','agent','asset','foreign intelligence','spy','covert','clandestine','tyler drumheller','unauthorized person','need to know','clearance'] }
};

function normalizeName(raw) {
  if (!raw) return null;
  let name = raw.split('<')[0].replace(/"/g, '').replace(/'/g, '').trim();
  if (!name || name.length < 2) return null;
  const lower = name.toLowerCase();
  if (KNOWN_NAMES[lower]) return KNOWN_NAMES[lower];
  // Try partial matches
  for (const [key, val] of Object.entries(KNOWN_NAMES)) {
    if (lower.includes(key) || key.includes(lower)) return val;
  }
  // Clean up email-only
  if (name.includes('@')) {
    const user = name.split('@')[0].toLowerCase();
    if (KNOWN_NAMES[user]) return KNOWN_NAMES[user];
    return null;
  }
  // Flip "Last, First" format
  if (name.includes(',')) {
    const parts = name.split(',').map(s => s.trim());
    if (parts.length === 2 && parts[1]) name = parts[1] + ' ' + parts[0];
  }
  return name.length > 2 ? name : null;
}

function classifyEmail(e) {
  const text = ((e.MetadataSubject || '') + ' ' + (e.ExtractedBodyText || '')).toLowerCase();
  const cats = [];
  for (const [key, cat] of Object.entries(CATEGORIES)) {
    if (cat.keywords.some(kw => text.includes(kw))) cats.push(key);
  }
  return cats;
}

function analyze() {
  const senderCounts = {};
  const recipientCounts = {};
  const pairCounts = {};
  const monthly = {};

  emails.forEach(e => {
    // Timeline
    if (e.MetadataDateSent) {
      const d = new Date(e.MetadataDateSent);
      const key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
      monthly[key] = (monthly[key] || 0) + 1;
    }

    const from = normalizeName(e.MetadataFrom || e.ExtractedFrom);
    const toRaw = (e.MetadataTo || '') + ';' + (e.ExtractedTo || '') + ';' + (e.ExtractedCc || '');
    const tos = new Set();
    toRaw.split(/[;,]/).forEach(t => {
      const n = normalizeName(t.trim());
      if (n) tos.add(n);
    });
    // Also map 'H' to Hillary
    if ((e.MetadataTo || '').trim() === 'H') tos.add('Hillary Clinton');
    if ((e.MetadataFrom || '').trim() === 'H' || (e.MetadataFrom || '').trim() === '') {
      // Many emails with empty From are from Hillary
    }

    if (from) {
      senderCounts[from] = (senderCounts[from] || 0) + 1;
      tos.forEach(to => {
        if (to !== from) {
          recipientCounts[to] = (recipientCounts[to] || 0) + 1;
          const pair = [from, to].sort().join(' ↔ ');
          pairCounts[pair] = (pairCounts[pair] || 0) + 1;
        }
      });
    }

    if (tos.size > 0 && !from) {
      tos.forEach(to => { recipientCounts[to] = (recipientCounts[to] || 0) + 1; });
    }
  });

  return { senderCounts, recipientCounts, pairCounts, monthly };
}

function renderSummary(data) {
  const uniqueSenders = Object.keys(data.senderCounts).length;
  const uniqueRecipients = Object.keys(data.recipientCounts).length;
  const uniquePairs = Object.keys(data.pairCounts).length;
  const months = Object.keys(data.monthly).length;

  document.getElementById('summaryRow').innerHTML = `
    <div class="summary-card"><div class="num">${emails.length.toLocaleString()}</div><div class="label">Total Emails</div></div>
    <div class="summary-card"><div class="num">${uniqueSenders}</div><div class="label">Unique Senders</div></div>
    <div class="summary-card"><div class="num">${uniqueRecipients}</div><div class="label">Unique Recipients</div></div>
    <div class="summary-card"><div class="num">${uniquePairs}</div><div class="label">Conversation Pairs</div></div>
    <div class="summary-card"><div class="num">${months}</div><div class="label">Months Spanned</div></div>
  `;
}

function renderTimeline(monthly) {
  const sorted = Object.entries(monthly).sort((a, b) => a[0].localeCompare(b[0]));
  if (sorted.length === 0) return;
  const max = Math.max(...sorted.map(s => s[1]));

  const el = document.getElementById('timeline');
  const labels = document.getElementById('timelineLabels');

  el.innerHTML = sorted.map(([month, count]) => {
    const pct = (count / max) * 100;
    const [y, m] = month.split('-');
    const monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const label = monthNames[parseInt(m)] + ' ' + y;
    return `<div class="timeline-bar" style="height:${Math.max(pct, 2)}%" data-tooltip="${label}: ${count} emails"></div>`;
  }).join('');

  labels.innerHTML = sorted.map(([month], i) => {
    const [y, m] = month.split('-');
    const monthNames = ['','J','F','M','A','M','J','J','A','S','O','N','D'];
    return i % 3 === 0 ? `<span>${monthNames[parseInt(m)]} ${y.slice(2)}</span>` : '<span></span>';
  }).join('');
}

function renderBarChart(containerId, counts, color, limit = 20) {
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, limit);
  if (sorted.length === 0) return;
  const max = sorted[0][1];

  document.getElementById(containerId).innerHTML = sorted.map(([name, count]) => {
    const pct = (count / max) * 100;
    return `
      <div class="bar-row">
        <div class="bar-label" title="${name}">${name}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:${color}">
            <span class="bar-value">${pct > 15 ? count : ''}</span>
          </div>
        </div>
        <div class="bar-count">${count}</div>
      </div>`;
  }).join('');
}

function renderPairTable(pairCounts) {
  const sorted = Object.entries(pairCounts).sort((a, b) => b[1] - a[1]).slice(0, 25);
  if (sorted.length === 0) return;
  const max = sorted[0][1];

  const tbody = document.querySelector('#pairTable tbody');
  tbody.innerHTML = sorted.map(([pair, count], i) => {
    const pct = (count / max) * 100;
    const perWeek = (count / 200).toFixed(1); // rough estimate over ~4 years
    return `
      <tr>
        <td class="pair-rank">${i + 1}</td>
        <td class="pair-names">${pair}</td>
        <td>${count}</td>
        <td class="pair-bar-cell"><div class="pair-bar" style="width:${pct}%"></div></td>
      </tr>`;
  }).join('');
}

function renderMatrix(senderCounts, recipientCounts, pairCounts) {
  // Get top 12 people by total involvement
  const involvement = {};
  Object.entries(senderCounts).forEach(([name, c]) => { involvement[name] = (involvement[name]||0) + c; });
  Object.entries(recipientCounts).forEach(([name, c]) => { involvement[name] = (involvement[name]||0) + c; });

  const topPeople = Object.entries(involvement).sort((a, b) => b[1] - a[1]).slice(0, 12).map(e => e[0]);

  // Build matrix
  const matrix = {};
  topPeople.forEach(a => { matrix[a] = {}; topPeople.forEach(b => { matrix[a][b] = 0; }); });

  Object.entries(pairCounts).forEach(([pair, count]) => {
    const [a, b] = pair.split(' ↔ ');
    if (matrix[a] && matrix[a][b] !== undefined) { matrix[a][b] += count; matrix[b][a] += count; }
  });

  const allVals = [];
  topPeople.forEach(a => topPeople.forEach(b => { if (a !== b) allVals.push(matrix[a][b]); }));
  const maxVal = Math.max(...allVals, 1);

  let html = '<table class="matrix-table"><thead><tr><th class="row-label"></th>';
  topPeople.forEach(p => {
    const short = p.split(' ').pop().substring(0, 8);
    html += `<th>${short}</th>`;
  });
  html += '</tr></thead><tbody>';

  topPeople.forEach(a => {
    const short = a.split(' ').pop().substring(0, 10);
    html += `<tr><td class="row-label">${short}</td>`;
    topPeople.forEach(b => {
      const val = matrix[a][b];
      if (a === b) {
        html += '<td><div class="matrix-cell" style="background:#e0e0e0;color:#999">—</div></td>';
      } else if (val === 0) {
        html += '<td><div class="matrix-cell" style="background:#f5f5f5;color:#bbb">0</div></td>';
      } else {
        const intensity = Math.min(val / maxVal, 1);
        const r = Math.round(66 - intensity * 40);
        const g = Math.round(133 - intensity * 50);
        const b2 = Math.round(244 - intensity * 100);
        const bg = `rgb(${r},${g},${b2})`;
        html += `<td><div class="matrix-cell" style="background:${bg}" title="${a} ↔ ${b}: ${val} emails">${val}</div></td>`;
      }
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('matrixContainer').innerHTML = html;
}

function renderCategoryBreakdown() {
  const catEmails = {};
  const catSenders = {};

  emails.forEach(e => {
    const cats = classifyEmail(e);
    const from = normalizeName(e.MetadataFrom || e.ExtractedFrom);
    cats.forEach(cat => {
      catEmails[cat] = (catEmails[cat] || 0) + 1;
      if (from) {
        if (!catSenders[cat]) catSenders[cat] = {};
        catSenders[cat][from] = (catSenders[cat][from] || 0) + 1;
      }
    });
  });

  const html = Object.entries(CATEGORIES).map(([key, cat]) => {
    const count = catEmails[key] || 0;
    if (count === 0) return '';
    const senders = catSenders[key] || {};
    const topSenders = Object.entries(senders).sort((a, b) => b[1] - a[1]).slice(0, 5);

    return `
      <div class="cat-card">
        <div class="cat-card-title"><div class="cat-dot" style="background:${cat.color}"></div>${cat.name}</div>
        <div class="stat-row"><span>Total flagged emails</span><strong>${count}</strong></div>
        <div class="stat-row"><span>% of archive</span><strong>${(count / emails.length * 100).toFixed(1)}%</strong></div>
        ${topSenders.map(([name, c]) =>
          `<div class="stat-row"><span>${name}</span><strong>${c}</strong></div>`
        ).join('')}
      </div>`;
  }).join('');

  document.getElementById('catGrid').innerHTML = html;
}

// Load and analyze
fetch('emails.json')
  .then(r => r.json())
  .then(data => {
    emails = data;
    const analysis = analyze();

    renderSummary(analysis);
    renderTimeline(analysis.monthly);
    renderBarChart('topSenders', analysis.senderCounts, '#4285f4');
    renderBarChart('topRecipients', analysis.recipientCounts, '#34a853');
    renderPairTable(analysis.pairCounts);
    renderMatrix(analysis.senderCounts, analysis.recipientCounts, analysis.pairCounts);
    renderCategoryBreakdown();
  });
</script>
</body>
</html>
