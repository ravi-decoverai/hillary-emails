<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hillary Clinton Emails</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Google Sans', Roboto, Arial, sans-serif; background: #f6f8fc; color: #202124; }

  /* Header */
  .header {
    background: #fff; height: 64px; display: flex; align-items: center;
    padding: 0 16px; border-bottom: 1px solid #e0e0e0; position: fixed;
    top: 0; left: 0; right: 0; z-index: 100;
  }
  .header .logo { display: flex; align-items: center; gap: 8px; width: 250px; }
  .header .logo svg { width: 40px; height: 40px; }
  .header .logo span { font-size: 22px; color: #5f6368; font-weight: 500; }
  .header .logo .title { color: #c5221f; font-weight: 600; }
  .search-bar {
    flex: 1; max-width: 720px; background: #eaf1fb; border-radius: 28px;
    display: flex; align-items: center; padding: 0 16px; height: 48px;
  }
  .search-bar input {
    flex: 1; border: none; background: none; font-size: 16px;
    outline: none; color: #202124; padding: 0 12px;
  }
  .search-bar svg { color: #5f6368; cursor: pointer; flex-shrink: 0; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
  .avatar {
    width: 36px; height: 36px; border-radius: 50%; background: #1a73e8;
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-weight: 600; font-size: 14px;
  }

  /* Layout */
  .container { display: flex; margin-top: 64px; min-height: calc(100vh - 64px); }

  /* Sidebar */
  .sidebar {
    width: 256px; padding: 8px 12px; flex-shrink: 0; position: fixed;
    top: 64px; bottom: 0; overflow-y: auto;
  }
  .compose-btn {
    background: #c2e7ff; border: none; border-radius: 16px; padding: 14px 24px;
    font-size: 14px; font-weight: 600; cursor: pointer; display: flex;
    align-items: center; gap: 12px; margin-bottom: 12px; width: fit-content;
    color: #001d35; transition: box-shadow 0.2s;
  }
  .compose-btn:hover { box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  .nav-item {
    display: flex; align-items: center; gap: 16px; padding: 6px 12px;
    border-radius: 24px; cursor: pointer; font-size: 14px; color: #444746;
    margin-bottom: 2px; position: relative;
  }
  .nav-item:hover { background: #e8eaed; }
  .nav-item.active { background: #d3e3fd; color: #001d35; font-weight: 600; }
  .nav-item .count { margin-left: auto; font-size: 12px; font-weight: 600; }
  .nav-item svg { width: 20px; height: 20px; flex-shrink: 0; }
  .nav-section {
    font-size: 11px; font-weight: 600; color: #5f6368; text-transform: uppercase;
    letter-spacing: 0.8px; padding: 16px 12px 6px; margin-top: 4px;
  }
  .nav-item .dot {
    width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  }

  /* Email List */
  .main { flex: 1; margin-left: 256px; }
  .toolbar {
    display: flex; align-items: center; padding: 4px 16px; gap: 4px;
    background: #f6f8fc; border-bottom: 1px solid #e0e0e0; position: sticky;
    top: 64px; z-index: 50; height: 48px;
  }
  .toolbar button {
    background: none; border: none; cursor: pointer; padding: 8px;
    border-radius: 50%; color: #5f6368;
  }
  .toolbar button:hover { background: #e8eaed; }
  .toolbar .page-info { margin-left: auto; font-size: 12px; color: #5f6368; }

  .email-list { background: #fff; }
  .email-row {
    display: flex; align-items: center; padding: 0 16px; height: 42px;
    border-bottom: 1px solid #f1f3f4; cursor: pointer; font-size: 14px;
    transition: box-shadow 0.15s;
  }
  .email-row:hover { box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0, 0 1px 2px 0 rgba(60,64,67,.3); z-index: 1; }
  .email-row.unread { font-weight: 600; background: #fff; }
  .email-row.read { background: #f2f6fc; }

  .email-row .checkbox { width: 40px; flex-shrink: 0; display: flex; align-items: center; }
  .email-row .checkbox input { width: 18px; height: 18px; cursor: pointer; accent-color: #1a73e8; }
  .email-row .star { width: 32px; flex-shrink: 0; cursor: pointer; color: #dadce0; font-size: 18px; }
  .email-row .star.starred { color: #f4b400; }
  .email-row .sender { width: 200px; flex-shrink: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .email-row .subject-snippet { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
  .email-row .subject-snippet .snippet { color: #5f6368; font-weight: 400; }
  .email-row .thread-count {
    background: #dadce0; color: #5f6368; font-size: 11px; font-weight: 600;
    padding: 0 6px; border-radius: 8px; flex-shrink: 0;
  }
  .email-row .category-dots { display: flex; gap: 3px; flex-shrink: 0; margin-right: 4px; }
  .email-row .category-dots .cat-dot { width: 8px; height: 8px; border-radius: 50%; }
  .email-row .date { width: 80px; text-align: right; flex-shrink: 0; font-size: 12px; color: #5f6368; }
  .email-row.unread .date { color: #202124; font-weight: 600; }

  /* Email Detail / Thread View */
  .email-detail { display: none; background: #fff; min-height: calc(100vh - 112px); }
  .email-detail.active { display: block; }
  .email-list.hidden { display: none; }

  .detail-toolbar {
    display: flex; align-items: center; padding: 8px 16px; gap: 4px;
    border-bottom: 1px solid #e0e0e0; position: sticky; top: 64px;
    background: #fff; z-index: 50;
  }
  .detail-toolbar button {
    background: none; border: none; cursor: pointer; padding: 8px;
    border-radius: 50%; color: #5f6368; font-size: 18px;
  }
  .detail-toolbar button:hover { background: #e8eaed; }

  .detail-content { padding: 20px 60px; max-width: 900px; }
  .detail-subject { font-size: 22px; font-weight: 400; color: #202124; margin-bottom: 20px; line-height: 1.4; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }

  .thread-message {
    border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 8px;
    overflow: hidden;
  }
  .thread-message-header {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    cursor: pointer; user-select: none;
  }
  .thread-message-header:hover { background: #f8f9fa; }
  .thread-message.collapsed .thread-message-body { display: none; }
  .thread-message.expanded { border-color: #dadce0; }
  .thread-message.expanded .thread-message-header { border-bottom: 1px solid #e0e0e0; }

  .detail-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    color: #fff; display: flex; align-items: center; justify-content: center;
    font-weight: 600; font-size: 16px; flex-shrink: 0;
  }
  .thread-meta { flex: 1; min-width: 0; }
  .thread-from { font-weight: 600; font-size: 14px; }
  .thread-to { font-size: 12px; color: #5f6368; margin-top: 1px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .thread-snippet { font-size: 13px; color: #5f6368; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .thread-date { font-size: 12px; color: #5f6368; white-space: nowrap; flex-shrink: 0; }

  .thread-message-body {
    padding: 16px 16px 16px 68px;
    font-size: 14px; line-height: 1.6; color: #202124;
    white-space: pre-wrap; word-wrap: break-word;
  }

  /* Category Labels */
  .label {
    display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 4px;
    font-size: 11px; font-weight: 600; white-space: nowrap;
  }
  .label-inbox { background: #e8f0fe; color: #1967d2; }
  .label-classified { background: #fce8e6; color: #c5221f; }
  .label-benghazi { background: #fef7e0; color: #e37400; }
  .label-personal-server { background: #f3e8fd; color: #8430ce; }
  .label-deleted { background: #fce8e6; color: #d93025; }
  .label-influence { background: #e6f4ea; color: #137333; }
  .label-foundation { background: #e0f2f1; color: #00897b; }

  /* Category filter chips */
  .filter-bar {
    display: flex; align-items: center; gap: 8px; padding: 8px 16px;
    background: #f6f8fc; border-bottom: 1px solid #e0e0e0; flex-wrap: wrap;
  }
  .filter-chip {
    display: inline-flex; align-items: center; gap: 4px; padding: 6px 14px;
    border-radius: 20px; border: 1px solid #dadce0; background: #fff;
    font-size: 13px; cursor: pointer; transition: all 0.15s; user-select: none;
  }
  .filter-chip:hover { background: #f1f3f4; }
  .filter-chip.active { border-color: transparent; color: #fff; font-weight: 600; }
  .filter-chip .chip-dot { width: 8px; height: 8px; border-radius: 50%; }
  .filter-chip .chip-count { font-size: 11px; opacity: 0.8; }

  .empty-state {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 300px; color: #5f6368; font-size: 14px;
  }

  @media (max-width: 768px) {
    .sidebar { display: none; }
    .main { margin-left: 0; }
    .email-row .sender { width: 120px; }
    .detail-content { padding: 16px; }
    .thread-message-body { padding: 12px; }
  }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo">
    <svg viewBox="0 0 40 40" fill="none">
      <rect width="40" height="40" rx="8" fill="#ea4335"/>
      <path d="M8 12l12 9 12-9v18H8z" fill="#fff" opacity="0.9"/>
      <path d="M8 12l12 9 12-9" stroke="#fff" stroke-width="1.5" fill="none"/>
    </svg>
    <span><span class="title">HRC</span> Mail</span>
  </div>
  <div class="search-bar">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
    <input type="text" id="searchInput" placeholder="Search mail" oninput="filterEmails()">
  </div>
  <div class="header-right">
    <div class="avatar">HC</div>
  </div>
</div>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <button class="compose-btn">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
      Compose
    </button>
    <div class="nav-item active" data-view="inbox" onclick="setView('inbox')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5v-3h3.56c.69 1.19 1.97 2 3.45 2s2.75-.81 3.45-2H19v3zm0-5h-4.99c0 1.1-.9 2-2 2s-2-.9-2-2H5V5h14v9z"/></svg>
      Inbox
      <span class="count" id="inboxCount"></span>
    </div>
    <div class="nav-item" data-view="starred" onclick="setView('starred')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
      Starred
      <span class="count" id="starredCount">0</span>
    </div>
    <div class="nav-item" data-view="all" onclick="setView('all')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/></svg>
      All Mail
    </div>

    <div class="nav-section">Categories</div>
    <div class="nav-item" data-view="cat-classified" onclick="setView('cat-classified')">
      <div class="dot" style="background:#c5221f"></div>
      Classified Info
      <span class="count" id="countClassified">0</span>
    </div>
    <div class="nav-item" data-view="cat-benghazi" onclick="setView('cat-benghazi')">
      <div class="dot" style="background:#e37400"></div>
      Benghazi
      <span class="count" id="countBenghazi">0</span>
    </div>
    <div class="nav-item" data-view="cat-personal-server" onclick="setView('cat-personal-server')">
      <div class="dot" style="background:#8430ce"></div>
      Private Server
      <span class="count" id="countPersonalServer">0</span>
    </div>
    <div class="nav-item" data-view="cat-deleted" onclick="setView('cat-deleted')">
      <div class="dot" style="background:#d93025"></div>
      Deletion Concerns
      <span class="count" id="countDeleted">0</span>
    </div>
    <div class="nav-item" data-view="cat-influence" onclick="setView('cat-influence')">
      <div class="dot" style="background:#137333"></div>
      Foreign Influence
      <span class="count" id="countInfluence">0</span>
    </div>
    <div class="nav-item" data-view="cat-foundation" onclick="setView('cat-foundation')">
      <div class="dot" style="background:#00897b"></div>
      Foundation Links
      <span class="count" id="countFoundation">0</span>
    </div>
    <div class="nav-item" data-view="cat-flagged" onclick="setView('cat-flagged')" style="margin-top:8px; color:#c5221f;">
      <svg viewBox="0 0 24 24" fill="currentColor" style="color:#c5221f"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
      All Flagged
      <span class="count" id="countFlagged">0</span>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <div class="toolbar" id="listToolbar">
      <button title="Select" onclick="toggleSelectAll()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>
      </button>
      <button title="Refresh" onclick="location.reload()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
      </button>
      <span class="page-info" id="pageInfo"></span>
    </div>

    <!-- Filter chips bar -->
    <div class="filter-bar" id="filterBar">
      <span style="font-size:12px;color:#5f6368;margin-right:4px;">Filter:</span>
    </div>

    <div class="email-list" id="emailList"></div>

    <div class="email-detail" id="emailDetail">
      <div class="detail-toolbar">
        <button title="Back to inbox" onclick="closeDetail()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </button>
        <button title="Archive">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/></svg>
        </button>
        <button title="Delete">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        </button>
      </div>
      <div class="detail-content" id="detailContent"></div>
    </div>
  </div>
</div>

<script>
let emails = [];
let threads = {};       // threadKey -> array of emails sorted by date
let threadList = [];     // array of thread objects for display
let starredIds = new Set();
let readIds = new Set();
let currentView = 'inbox';
let activeFilters = new Set();

const colors = ['#a142f4','#1a73e8','#ea4335','#34a853','#fa7b17','#f538a0','#00897b','#e37400'];

// --- Category definitions & keyword-based classification ---
const CATEGORIES = {
  classified: {
    name: 'Classified Info', color: '#c5221f', labelClass: 'label-classified',
    keywords: ['classified','confidential','secret','top secret','sensitive','noforn',
      'unclassified','redact','b1','b6','b5','1.4(b)','1.4(d)','class: secret',
      'declassif','intelligence','nsa','cia','dni','sigint','humint','comint']
  },
  benghazi: {
    name: 'Benghazi', color: '#e37400', labelClass: 'label-benghazi',
    keywords: ['benghazi','libya','libyan','qaddafi','gaddafi','tripoli','stevens',
      'ambassador stevens','consulate attack','annex','cia annex','militia']
  },
  'personal-server': {
    name: 'Private Server', color: '#8430ce', labelClass: 'label-personal-server',
    keywords: ['private server','personal email','hdr22','clintonemail','home server',
      'personal server','blackberry','ipad','secure fax','secure phone','burn after',
      'non-paper','off the record','remove heading','remove classification',
      'send nonsecure','non-secure','unclass']
  },
  deleted: {
    name: 'Deletion Concerns', color: '#d93025', labelClass: 'label-deleted',
    keywords: ['delete','deleted','destroy','destroyed','wipe','wiped','bleachbit',
      'print and delete','burn','shred','remove from','get rid of','scrub']
  },
  influence: {
    name: 'Foreign Influence', color: '#137333', labelClass: 'label-influence',
    keywords: ['saudi','qatar','uae','bahrain','donation','donor','foreign government',
      'foreign agent','foreign contribution','lobbying','lobby','cgep','teneo',
      'band','doug band','huma','blumenthal','favors','favor','access']
  },
  foundation: {
    name: 'Foundation Links', color: '#00897b', labelClass: 'label-foundation',
    keywords: ['clinton foundation','cgep','clinton global','cgi','foundation',
      'laureate','teneo','speeches','speaking fee','donors','fundrais','charitable']
  }
};

function classifyEmail(email) {
  const text = ((email.MetadataSubject || '') + ' ' + (email.ExtractedBodyText || '')).toLowerCase();
  const cats = [];
  for (const [key, cat] of Object.entries(CATEGORIES)) {
    if (cat.keywords.some(kw => text.includes(kw))) {
      cats.push(key);
    }
  }
  return cats;
}

function normalizeSubject(s) {
  return (s || '').replace(/^(re|fw|fwd)\s*:\s*/gi, '').trim().toLowerCase();
}

function getInitials(name) {
  if (!name) return '?';
  const clean = name.replace(/<[^>]*>/g, '').replace(/"/g, '').trim();
  const parts = clean.split(/[\s,]+/).filter(Boolean);
  if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
  return clean.substring(0, 2).toUpperCase();
}

function getColor(name) {
  let hash = 0;
  for (let i = 0; i < (name||'').length; i++) hash = ((hash << 5) - hash) + name.charCodeAt(i);
  return colors[Math.abs(hash) % colors.length];
}

function formatSender(from) {
  if (!from) return 'Unknown';
  const match = from.match(/^([^<]+)/);
  return match ? match[1].replace(/"/g,'').trim() : from;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[d.getMonth()] + ' ' + d.getDate();
  } catch { return ''; }
}

function formatDateFull(dateStr) {
  if (!dateStr) return '';
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { weekday:'short', year:'numeric', month:'short', day:'numeric', hour:'numeric', minute:'2-digit' });
  } catch { return dateStr; }
}

function getSnippet(body) {
  if (!body) return '';
  const clean = body.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim();
  return clean.length > 80 ? clean.substring(0, 80) + '...' : clean;
}

function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

function buildThreads() {
  threads = {};
  emails.forEach(e => {
    e._categories = classifyEmail(e);
    const key = normalizeSubject(e.MetadataSubject);
    if (!threads[key]) threads[key] = [];
    threads[key].push(e);
  });

  // Sort each thread chronologically
  for (const key in threads) {
    threads[key].sort((a, b) => new Date(a.MetadataDateSent || 0) - new Date(b.MetadataDateSent || 0));
  }

  // Build thread list sorted by latest message date
  threadList = Object.entries(threads).map(([key, msgs]) => {
    const latest = msgs[msgs.length - 1];
    const allCats = new Set();
    msgs.forEach(m => m._categories.forEach(c => allCats.add(c)));
    const senders = [...new Set(msgs.map(m => formatSender(m.MetadataFrom || m.ExtractedFrom || 'Unknown')))];
    return {
      key,
      messages: msgs,
      subject: latest.MetadataSubject || '(no subject)',
      latestDate: latest.MetadataDateSent,
      senders,
      categories: [...allCats],
      latestId: latest.Id,
      snippet: getSnippet(latest.ExtractedBodyText)
    };
  }).sort((a, b) => new Date(b.latestDate || 0) - new Date(a.latestDate || 0));
}

function getVisibleThreads() {
  let list = threadList;
  const query = document.getElementById('searchInput').value.toLowerCase();

  // View filter
  if (currentView === 'starred') {
    list = list.filter(t => t.messages.some(m => starredIds.has(m.Id)));
  } else if (currentView.startsWith('cat-')) {
    const cat = currentView.replace('cat-', '');
    if (cat === 'flagged') {
      list = list.filter(t => t.categories.length > 0);
    } else {
      list = list.filter(t => t.categories.includes(cat));
    }
  }

  // Active filter chips
  if (activeFilters.size > 0) {
    list = list.filter(t => {
      for (const f of activeFilters) {
        if (!t.categories.includes(f)) return false;
      }
      return true;
    });
  }

  // Search
  if (query) {
    list = list.filter(t => t.messages.some(m =>
      (m.MetadataSubject || '').toLowerCase().includes(query) ||
      (m.MetadataFrom || '').toLowerCase().includes(query) ||
      (m.MetadataTo || '').toLowerCase().includes(query) ||
      (m.ExtractedBodyText || '').toLowerCase().includes(query)
    ));
  }

  return list;
}

function renderFilterChips() {
  const bar = document.getElementById('filterBar');
  const catCounts = {};
  threadList.forEach(t => t.categories.forEach(c => { catCounts[c] = (catCounts[c]||0) + 1; }));

  let html = '<span style="font-size:12px;color:#5f6368;margin-right:4px;">Filter:</span>';
  for (const [key, cat] of Object.entries(CATEGORIES)) {
    const count = catCounts[key] || 0;
    if (count === 0) continue;
    const isActive = activeFilters.has(key);
    html += `<div class="filter-chip ${isActive ? 'active' : ''}"
      style="${isActive ? 'background:'+cat.color+';border-color:'+cat.color : ''}"
      onclick="toggleFilter('${key}')">
      <div class="chip-dot" style="background:${isActive ? '#fff' : cat.color}"></div>
      ${cat.name} <span class="chip-count">(${count})</span>
    </div>`;
  }
  bar.innerHTML = html;
}

function toggleFilter(cat) {
  if (activeFilters.has(cat)) activeFilters.delete(cat);
  else activeFilters.add(cat);
  renderFilterChips();
  renderEmailList(getVisibleThreads());
}

function renderEmailList(list) {
  const el = document.getElementById('emailList');
  if (list.length === 0) {
    el.innerHTML = '<div class="empty-state"><p>No emails match your criteria.</p></div>';
    document.getElementById('pageInfo').textContent = '';
    return;
  }

  const totalMsgs = list.reduce((s, t) => s + t.messages.length, 0);
  document.getElementById('pageInfo').textContent = `${list.length} conversations (${totalMsgs} messages)`;

  el.innerHTML = list.map(t => {
    const latest = t.messages[t.messages.length - 1];
    const isRead = t.messages.every(m => readIds.has(m.Id));
    const isStarred = t.messages.some(m => starredIds.has(m.Id));
    const senderDisplay = t.senders.length > 2
      ? t.senders.slice(0, 2).join(', ') + ' +' + (t.senders.length - 2)
      : t.senders.join(', ');

    const catDots = t.categories.map(c =>
      `<div class="cat-dot" style="background:${CATEGORIES[c].color}" title="${CATEGORIES[c].name}"></div>`
    ).join('');

    const threadBadge = t.messages.length > 1
      ? `<span class="thread-count">${t.messages.length}</span>` : '';

    return `
      <div class="email-row ${isRead ? 'read' : 'unread'}" onclick="openThread('${escAttr(t.key)}')">
        <div class="checkbox"><input type="checkbox" onclick="event.stopPropagation()"></div>
        <div class="star ${isStarred ? 'starred' : ''}" onclick="event.stopPropagation(); toggleStarThread('${escAttr(t.key)}')">
          ${isStarred ? '&#9733;' : '&#9734;'}
        </div>
        <div class="sender">${escHtml(senderDisplay)}</div>
        <div class="category-dots">${catDots}</div>
        <div class="subject-snippet">
          <span>${escHtml(t.subject)}</span>
          ${threadBadge}
          <span class="snippet"> &mdash; ${escHtml(t.snippet)}</span>
        </div>
        <div class="date">${formatDate(t.latestDate)}</div>
      </div>`;
  }).join('');
}

function escAttr(str) {
  return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function openThread(key) {
  const thread = threads[key];
  if (!thread || thread.length === 0) return;

  // Mark all as read
  thread.forEach(m => readIds.add(m.Id));

  const subject = thread[thread.length - 1].MetadataSubject || '(no subject)';
  const allCats = new Set();
  thread.forEach(m => m._categories.forEach(c => allCats.add(c)));

  const catLabels = [...allCats].map(c =>
    `<span class="label ${CATEGORIES[c].labelClass}">${CATEGORIES[c].name}</span>`
  ).join('');

  const messagesHtml = thread.map((m, i) => {
    const sender = formatSender(m.MetadataFrom || m.ExtractedFrom || 'Unknown');
    const initials = getInitials(sender);
    const color = getColor(sender);
    const isLast = i === thread.length - 1;
    const collapsed = !isLast && thread.length > 1;

    return `
      <div class="thread-message ${collapsed ? 'collapsed' : 'expanded'}" onclick="toggleMessage(this, event)">
        <div class="thread-message-header">
          <div class="detail-avatar" style="background:${color}">${initials}</div>
          <div class="thread-meta">
            <div class="thread-from">${escHtml(sender)}</div>
            ${collapsed
              ? `<div class="thread-snippet">${escHtml(getSnippet(m.ExtractedBodyText))}</div>`
              : `<div class="thread-to">to ${escHtml(m.MetadataTo || 'me')}</div>`
            }
          </div>
          <div class="thread-date">${formatDateFull(m.MetadataDateSent)}</div>
        </div>
        <div class="thread-message-body">${escHtml(m.ExtractedBodyText || '')}</div>
      </div>`;
  }).join('');

  document.getElementById('detailContent').innerHTML = `
    <div class="detail-subject">
      ${escHtml(subject)}
      <span class="label label-inbox">Inbox</span>
      ${catLabels}
    </div>
    <div style="font-size:12px;color:#5f6368;margin-bottom:16px;">${thread.length} message${thread.length > 1 ? 's' : ''} in this conversation</div>
    ${messagesHtml}
  `;

  document.getElementById('emailList').classList.add('hidden');
  document.getElementById('listToolbar').style.display = 'none';
  document.getElementById('filterBar').style.display = 'none';
  document.getElementById('emailDetail').classList.add('active');
}

function toggleMessage(el, event) {
  // Don't toggle if clicking inside the body
  if (event.target.closest('.thread-message-body')) return;
  const wasCollapsed = el.classList.contains('collapsed');
  el.classList.toggle('collapsed');
  el.classList.toggle('expanded');

  // Update snippet/to display
  if (wasCollapsed) {
    const toEl = el.querySelector('.thread-snippet');
    if (toEl) {
      const from = el.querySelector('.thread-from').textContent;
      toEl.outerHTML = `<div class="thread-to">to me</div>`;
    }
  }
}

function closeDetail() {
  document.getElementById('emailDetail').classList.remove('active');
  document.getElementById('emailList').classList.remove('hidden');
  document.getElementById('listToolbar').style.display = '';
  document.getElementById('filterBar').style.display = '';
  renderEmailList(getVisibleThreads());
}

function toggleStarThread(key) {
  const thread = threads[key];
  if (!thread) return;
  const anyStarred = thread.some(m => starredIds.has(m.Id));
  thread.forEach(m => {
    if (anyStarred) starredIds.delete(m.Id);
    else starredIds.add(m.Id);
  });
  document.getElementById('starredCount').textContent = starredIds.size;
  renderEmailList(getVisibleThreads());
}

function setView(view) {
  currentView = view;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const el = document.querySelector(`.nav-item[data-view="${view}"]`);
  if (el) el.classList.add('active');
  activeFilters.clear();
  renderFilterChips();
  closeDetail();
}

function filterEmails() { renderEmailList(getVisibleThreads()); }

function updateSidebarCounts() {
  const catCounts = {};
  let flaggedTotal = 0;
  threadList.forEach(t => {
    t.categories.forEach(c => { catCounts[c] = (catCounts[c]||0) + 1; });
    if (t.categories.length > 0) flaggedTotal++;
  });

  document.getElementById('inboxCount').textContent = threadList.length;
  document.getElementById('countClassified').textContent = catCounts['classified'] || 0;
  document.getElementById('countBenghazi').textContent = catCounts['benghazi'] || 0;
  document.getElementById('countPersonalServer').textContent = catCounts['personal-server'] || 0;
  document.getElementById('countDeleted').textContent = catCounts['deleted'] || 0;
  document.getElementById('countInfluence').textContent = catCounts['influence'] || 0;
  document.getElementById('countFoundation').textContent = catCounts['foundation'] || 0;
  document.getElementById('countFlagged').textContent = flaggedTotal;
}

// Load data
fetch('emails.json')
  .then(r => r.json())
  .then(data => {
    emails = data.sort((a, b) => new Date(b.MetadataDateSent || 0) - new Date(a.MetadataDateSent || 0));
    emails.slice(Math.floor(emails.length * 0.4)).forEach(e => readIds.add(e.Id));
    buildThreads();
    updateSidebarCounts();
    renderFilterChips();
    renderEmailList(getVisibleThreads());
  });

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDetail();
});
</script>
</body>
</html>
